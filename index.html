<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - VRAIE VERSION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        body { background: #050508; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- LAYOUT PC (3 COLONNES) --- */
        #left-col, #right-col { width: 320px; border: 1px solid #00f2ff22; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; z-index: 10; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; border-left: 2px solid #00f2ff44; border-right: 2px solid #00f2ff44; }

        /* GAUCHE : Leaderboard & PayPal */
        .panel-title { padding: 15px; background: rgba(0,242,255,0.1); color: #00f2ff; font-weight: 900; text-align: center; border-bottom: 1px solid #00f2ff22; }
        #leaderboard { flex-grow: 1; padding: 10px; font-size: 12px; overflow-y: auto; }
        .paypal-area { padding: 15px; border-top: 1px solid #00f2ff22; text-align: center; }
        .paypal-btn { color: #ffc439; text-decoration: none; font-weight: 900; font-size: 13px; border: 1px solid #ffc439; padding: 10px; display: block; border-radius: 5px; background: rgba(255,196,57,0.05); }

        /* DROITE : Admin (30%) & Boutique (70%) */
        #admin-box { height: 30%; border-bottom: 1px solid #00f2ff22; display: flex; flex-direction: column; }
        #shop-box { height: 70%; display: flex; flex-direction: column; }
        #logs-list { flex-grow: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 10px; color: #888; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; overflow-y: auto; }
        .shop-item { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 8px; border-radius: 5px; text-align: center; cursor: pointer; font-size: 10px; transition: 0.2s; }
        .shop-item:hover { border-color: #00f2ff; }
        .shop-item.owned { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.05); }

        /* JEU */
        #app-container { height: 95vh; aspect-ratio: 9/16; position: relative; border: 2px solid #00f2ff; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        .page { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; text-align: center; }
        .active { display: flex !important; }
        .btn { border: 2px solid #00f2ff; padding: 12px 25px; background: rgba(0,242,255,0.1); color: #00f2ff; cursor: pointer; font-weight: 900; margin: 10px; text-transform: uppercase; }

        /* MOBILE */
        @media (max-width: 1050px) {
            #left-col, #right-col { display: none; }
            #app-container { width: 100vw; height: 100vh; border: none; }
            .mobile-ctrl { display: flex !important; }
        }
        .mobile-ctrl { display: none; position: absolute; bottom: 40px; width: 80px; height: 80px; border: 3px solid #fff; border-radius: 50%; justify-content: center; align-items: center; z-index: 200; background: rgba(255,255,255,0.1); font-weight: 900; }
        #btn-L { left: 20px; } #btn-R { right: 20px; }
    </style>
</head>
<body>

    <div id="left-col">
        <div class="panel-title">üèÜ TOP PILOTES</div>
        <div id="leaderboard"></div>
        <div class="paypal-area">
            <a href="https://www.paypal.me/CyberDash93" target="_blank" class="paypal-btn">Soutenir (PayPal / Coffee)</a>
        </div>
    </div>

    <div id="game-col">
        <div id="app-container">
            <div id="btn-L" class="mobile-ctrl">L</div>
            <div id="btn-R" class="mobile-ctrl">R</div>

            <div id="page-login" class="page active">
                <h1 style="color:#00f2ff; margin-bottom:20px;">CYBER DASH</h1>
                <input type="text" id="pseudoInput" placeholder="PSEUDO..." style="padding:12px; background:none; border:2px solid #00f2ff; color:#fff; font-family:'Orbitron'; text-align:center;">
                <div class="btn" onclick="login()">Lancer</div>
            </div>

            <div id="page-hub" class="page">
                <h2 id="user-points" style="color:#ffc439; margin-bottom:15px;">Points: 0</h2>
                <div id="levelGrid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:20px;"></div>
                <div class="btn" onclick="startMode('INFINITE')">Mode Infini</div>
            </div>

            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div id="admin-box">
            <div class="panel-title" style="font-size:10px; cursor:pointer;" onclick="askAdmin()">üõ∞Ô∏è LOGS (ACC√àS ADMIN)</div>
            <div id="logs-list"></div>
        </div>
        <div id="shop-box">
            <div class="panel-title">üõí BOUTIQUE SKINS</div>
            <div class="shop-grid" id="shop-items"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 600; canvas.height = 1000;

    let pseudo = "", userIP = "", isAdmin = false, points = 0, reached = 1;
    let ballX = 300, obstacles = [], keys = {}, state = "LOGIN", score = 0;
    let ballColor = "#ffffff", ownedSkins = ["#ffffff"];

    const shopItems = [
        {name: "Bleu N√©on", price: 200, color: "#00f2ff"},
        {name: "Vert Toxique", price: 500, color: "#39ff14"},
        {name: "Rouge Alerte", price: 1000, color: "#ff3131"},
        {name: "Violet Dark", price: 1500, color: "#bc13fe"},
        {name: "Or Pur", price: 2500, color: "#ffdf00"},
        {name: "CHROME", price: 5000, color: "chrome"}
    ];

    function askAdmin() {
        if(prompt("Code Admin (2011):") === "2011") { 
            isAdmin = true; 
            addLog("SYSTEM", "MODE ADMIN ACTIV√â"); 
        }
    }

    function addLog(user, msg, isPriv = false) {
        if(isPriv && !isAdmin) return;
        const div = document.createElement('div');
        div.style.padding = "2px 0";
        div.innerHTML = `<span style="color:#00f2ff">${new Date().toLocaleTimeString()}</span> - ${user}: ${msg}`;
        document.getElementById('logs-list').prepend(div);
    }

    function login() {
        pseudo = document.getElementById('pseudoInput').value.trim().toUpperCase();
        if(pseudo.length < 2) return;
        document.getElementById('page-login').classList.remove('active');
        document.getElementById('page-hub').classList.add('active');
        
        fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
            userIP = d.ip.replace(/\./g, '_');
            db.ref('users/' + userIP).on('value', snap => {
                const data = snap.val() || {};
                points = data.points || 0;
                reached = data.reached || 1;
                ownedSkins = data.skins || ["#ffffff"];
                ballColor = data.currentBall || "#ffffff";
                document.getElementById('user-points').innerText = "Cyber-Points: " + points;
                renderShop(); renderLevels();
            });
            addLog(pseudo, "SESSION OUVERTE");
            addLog(pseudo, `IP: ${d.ip} | ${d.country}`, true);
        });
        
        // Leaderboard
        db.ref('users').orderByChild('points').limitToLast(10).on('value', snap => {
            let html = "";
            let arr = [];
            snap.forEach(s => { arr.push(s.val()); });
            arr.reverse().forEach((p, i) => {
                html += `<div style="padding:5px; border-bottom:1px solid #111;">${i+1}. ${p.pseudo || 'ANON'} - ${p.points || 0} pts</div>`;
            });
            document.getElementById('leaderboard').innerHTML = html;
        });
    }

    function renderShop() {
        let html = "";
        shopItems.forEach(item => {
            const isOwned = ownedSkins.includes(item.color);
            html += `<div class="shop-item ${isOwned?'owned':''}" onclick="buyItem('${item.color}', ${item.price})">
                <div style="width:20px; height:20px; background:${item.color==='chrome'?'#aaa':item.color}; margin:0 auto 5px; border-radius:50%"></div>
                ${item.name}<br>${isOwned ? '√âQUIPER' : item.price + ' pts'}
            </div>`;
        });
        document.getElementById('shop-items').innerHTML = html;
    }

    function buyItem(color, price) {
        if(ownedSkins.includes(color)) {
            ballColor = color;
            db.ref('users/' + userIP).update({ currentBall: color });
            return;
        }
        if(points >= price) {
            points -= price;
            ownedSkins.push(color);
            db.ref('users/' + userIP).update({ points, skins: ownedSkins, currentBall: color });
            addLog(pseudo, "Achat Skin: " + color);
        }
    }

    function renderLevels() {
        let h = "";
        for(let i=1; i<=9; i++) {
            let unlock = i <= reached;
            h += `<div class="btn" style="padding:10px; font-size:12px; opacity:${unlock?1:0.3}" onclick="if(${unlock}) startSaga(${i})">NIV ${i}</div>`;
        }
        document.getElementById('levelGrid').innerHTML = h;
    }

    function startSaga(l) { state = "PLAY"; obstacles = []; score = 0; ballX = 300; document.getElementById('page-hub').classList.remove('active'); }
    function startMode(m) { state = "PLAY"; obstacles = []; score = 0; ballX = 300; document.getElementById('page-hub').classList.remove('active'); }

    window.onkeydown = e => { if(e.key==="q" || e.key==="ArrowLeft") keys["L"]=true; if(e.key==="d" || e.key==="ArrowRight") keys["R"]=true; };
    window.onkeyup = e => { if(e.key==="q" || e.key==="ArrowLeft") keys["L"]=false; if(e.key==="d" || e.key==="ArrowRight") keys["R"]=false; };
    document.getElementById('btn-L').ontouchstart = (e) => { e.preventDefault(); keys["L"]=true; };
    document.getElementById('btn-L').ontouchend = () => keys["L"]=false;
    document.getElementById('btn-R').ontouchstart = (e) => { e.preventDefault(); keys["R"]=true; };
    document.getElementById('btn-R').ontouchend = () => keys["R"]=false;

    function gameLoop() {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);
        if(state === "PLAY") {
            if(keys["L"]) ballX -= 9.5; if(keys["R"]) ballX += 9.5;
            ballX = Math.max(45, Math.min(555, ballX));

            if(Math.random() < 0.05) obstacles.push({gap: Math.random()*300+150, y: -50, passed: false});
            obstacles.forEach(o => {
                o.y += 8.5;
                ctx.fillStyle = "#00f2ff";
                ctx.fillRect(0, o.y, o.gap-110, 40); ctx.fillRect(o.gap+110, o.y, 600, 40);

                if(o.y > 720 && o.y < 780 && (ballX < o.gap-85 || ballX > o.gap+85)) {
                    addLog(pseudo, "CRASH! Score: " + score);
                    db.ref('users/' + userIP).update({ points: points + score, pseudo: pseudo });
                    state = "HUB"; document.getElementById('page-hub').classList.add('active');
                }
                if(o.y > 750 && !o.passed) { o.passed = true; score++; }
            });
            obstacles = obstacles.filter(o => o.y < 1100);

            ctx.beginPath();
            if(ballColor === "chrome") {
                let g = ctx.createLinearGradient(ballX-25, 725, ballX+25, 775);
                g.addColorStop(0, "#888"); g.addColorStop(0.5, "#fff"); g.addColorStop(1, "#444");
                ctx.fillStyle = g;
            } else { ctx.fillStyle = ballColor; }
            ctx.shadowBlur = 15; ctx.shadowColor = ballColor === "chrome" ? "#fff" : ballColor;
            ctx.arc(ballX, 750, 25, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = "#fff"; ctx.font = "900 80px Orbitron"; ctx.textAlign = "center";
            ctx.fillText(score, 300, 150);
        }
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>
