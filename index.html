<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - ORIGINAL SPACE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #left-col, #right-col { width: 320px; background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; z-index: 10; }
        #right-col { border-right: none; border-left: 1px solid #222; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
        
        #container { height: 95vh; aspect-ratio: 9/16; position: relative; border: 3px solid #fff; background: #000; overflow: hidden; box-shadow: 0 0 30px rgba(255,255,255,0.1); }
        canvas { width: 100%; height: 100%; display: block; position: relative; z-index: 5; }

        /* BOUTONS MOBILES BLANCS ORIGINAUX */
        .m-btn { display: none; position: absolute; bottom: 40px; width: 85px; height: 85px; background: rgba(255,255,255,0.05); border: 3px solid #fff; border-radius: 50%; z-index: 500; justify-content: center; align-items: center; font-weight: 900; color: #fff; box-shadow: 0 0 20px #fff; font-size: 24px; }
        .m-btn.active-press { background: #fff; color: #000; box-shadow: 0 0 50px #fff; transform: scale(0.9); }
        #btn-L { left: 20px; } #btn-R { right: 20px; }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; text-align: center; }
        .active-screen { display: flex !important; }
        
        .panel-title { padding: 20px; text-align: center; font-weight: 900; border-bottom: 1px solid #222; cursor: pointer; letter-spacing: 3px; color: #fff; text-shadow: 0 0 10px #fff; }
        
        .btn-ui { border: 2px solid #fff; padding: 15px 30px; color: #fff; cursor: pointer; font-weight: 900; margin-top: 15px; background: none; font-family: 'Orbitron'; transition: 0.3s; width: 80%; }
        .btn-ui:hover { background: #fff; color: #000; }

        .scroll-zone { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .item-card { background: #111; margin-bottom: 10px; padding: 15px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { background: #fff; color: #000; border: none; padding: 8px 15px; font-weight: 900; cursor: pointer; font-family: 'Orbitron'; }
        
        #white-flash { position: absolute; inset: 0; background: #fff; opacity: 0; z-index: 1000; pointer-events: none; transition: opacity 0.5s; }

        @media (max-width: 1000px) { #left-col, #right-col { display: none; } #container { width: 100vw; height: 100vh; border: none; } .m-btn { display: flex; } }
    </style>
</head>
<body>

    <div id="left-col">
        <div class="panel-title" ondblclick="adminUnlock()">CLASSEMENT</div>
        <div id="leaderboard" class="scroll-zone"></div>
    </div>

    <div id="game-col">
        <div id="container">
            <div id="white-flash"></div>
            <div id="btn-L" class="m-btn">L</div><div id="btn-R" class="m-btn">R</div>
            
            <div id="screen-login" class="screen active-screen">
                <h1 style="font-size:35px; margin-bottom:20px;">CYBER DASH</h1>
                <input type="text" id="nick" placeholder="PSEUDO..." maxlength="10" style="padding:15px; background:none; border:2px solid #fff; color:#fff; text-align:center; font-family:'Orbitron'; outline:none; margin-bottom:20px;">
                <button class="btn-ui" onclick="init()">START ENGINE</button>
            </div>

            <div id="screen-hub" class="screen">
                <div id="hub-stats" style="margin-bottom:20px; color:#fff;"></div>
                <div id="lvls" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>
                <button class="btn-ui" style="border-color:#ff007f; color:#ff007f;" onclick="start('INF')">INFINI âˆž</button>
            </div>

            <canvas id="cvs"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div class="panel-title">BOUTIQUE</div>
        <div id="shop" class="scroll-zone"></div>
        <div id="user-coins" style="text-align:center; padding:20px; color:#ffd700; font-size:24px; font-weight:900;">0 ðŸª™</div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0", authDomain: "cyberdash-2baf5.firebaseapp.com", databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app", projectId: "cyberdash-2baf5", storageBucket: "cyberdash-2baf5.firebasestorage.app", messagingSenderId: "360233647601", appId: "1:360233647601:web:60aa25f439019ed7511850" };
    firebase.initializeApp(firebaseConfig); const db = firebase.database();
    const cvs = document.getElementById("cvs"); const ctx = cvs.getContext("2d"); cvs.width = 600; cvs.height = 1000;
    
    let user="", ip="", coins=0, record=0, reached=1, ballX=300, ballY=750, ballVX=0, obs=[], pieces=[], stars=[], particles=[], keys={}, state="LOGIN", score=0, currentLvl=1;
    let ballColor="#fff", currentTrail="none", owned=["#fff", "none"];

    // FOND ESPACE Ã‰TOILÃ‰ (Parallaxe)
    for(let i=0; i<120; i++) stars.push({x:Math.random()*600, y:Math.random()*1000, s:Math.random()*2+0.5});

    function adminUnlock() { if(prompt("CODE ADMIN?")==="2011"){ coins+=15000; reached=9; sync(); alert("ADMIN ACTIF"); }}
    function sync() { db.ref('users/'+ip).update({coins, record, reached, owned, ballColor, currentTrail, user}); }

    function init() {
        user = document.getElementById('nick').value.toUpperCase() || "PLAYER";
        document.getElementById('screen-login').classList.remove('active-screen'); document.getElementById('screen-hub').classList.add('active-screen');
        fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{
            ip = d.ip.replace(/\./g, '_');
            db.ref('users/'+ip).on('value', s=>{
                const v = s.val()||{}; coins=v.coins||0; record=v.record||0; reached=v.reached||1; 
                owned=v.owned||["#fff", "none"]; ballColor=v.ballColor||"#fff"; currentTrail=v.currentTrail||"none";
                document.getElementById('user-coins').innerText = `${coins} ðŸª™`;
                document.getElementById('hub-stats').innerText = `RECORD: ${record} | NIVEAU: ${reached}`;
                renderShop(); renderLvls();
            });
        });
        db.ref('users').orderByChild('record').limitToLast(10).on('value', s=>{
            let h=""; s.forEach(x=>{ let p=x.val(); h+=`<div class="item-card"><span>${p.user||'ANON'}</span><b>${p.record||0}</b></div>`; });
            document.getElementById('leaderboard').innerHTML=h;
        });
    }

    const shopItems = [{id:"#fff",n:"WHITE",p:0,t:"skin"},{id:"#00f2ff",n:"CYAN",p:500,t:"skin"},{id:"rainbow",n:"RAINBOW",p:1000,t:"trail"}];
    function renderShop() {
        let h=""; shopItems.forEach(i=>{
            let isO=owned.includes(i.id); h+=`<div class="item-card"><span>${i.n}</span><button class="buy-btn" onclick="buy('${i.id}',${i.p},'${i.t}')">${isO?'SELECT':'BUY'}</button></div>`;
        }); document.getElementById('shop').innerHTML=h;
    }
    function buy(id,p,t) { if(owned.includes(id)){ if(t==="skin")ballColor=id; else currentTrail=id; }else if(coins>=p){coins-=p; owned.push(id); if(t==="skin")ballColor=id; else currentTrail=id;} sync(); }
    function renderLvls() { let h=""; for(let i=1; i<=9; i++) h+=`<div class="btn-ui" style="opacity:${i<=reached?1:0.2}; width:auto; margin:5px;" onclick="if(${i<=reached})start(${i})">${i}</div>`; document.getElementById('lvls').innerHTML=h; }
    
    function start(l) { currentLvl=l; state="PLAY"; score=0; obs=[]; pieces=[]; ballX=300; ballY=750; document.getElementById('screen-hub').classList.remove('active-screen'); }

    const press = (id,k,act) => { keys[k]=act; document.getElementById(id).classList.toggle('active-press', act); };
    document.getElementById('btn-L').ontouchstart=e=>{e.preventDefault(); press('btn-L','L',true)};
    document.getElementById('btn-L').ontouchend=()=>press('btn-L','L',false);
    document.getElementById('btn-R').ontouchstart=e=>{e.preventDefault(); press('btn-R','R',true)};
    document.getElementById('btn-R').ontouchend=()=>press('btn-R','R',false);

    function loop() {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);
        
        // DESSIN DES Ã‰TOILES
        stars.forEach(s => { 
            s.y += (state==="PLAY") ? s.s * 2 : s.s * 0.5; 
            if(s.y>1000) s.y=0; 
            ctx.fillStyle="#fff"; 
            ctx.fillRect(s.x,s.y,s.s,s.s); 
        });

        if(state==="PLAY" || state==="CINEMATIC") {
            let color = (currentLvl==='INF') ? `hsl(${Date.now()/5},100%,50%)` : "#fff";
            
            if(state==="PLAY") { 
                if(keys["L"])ballVX-=2; if(keys["R"])ballVX+=2; 
                ballVX*=0.85; ballX+=ballVX; ballX=Math.max(30,Math.min(570,ballX)); 
            } else { 
                ballY-=15; 
                if(ballY<50) { 
                    document.getElementById('white-flash').style.opacity="1";
                    setTimeout(()=>location.reload(), 600);
                } 
            }

            const speed = (currentLvl==='INF')?11:7;
            const gap = (currentLvl==='INF')?145:185;
            
            if(state==="PLAY" && Math.random()<0.045 && (obs.length===0 || obs[obs.length-1].y>280)) {
                let c = Math.random()*(400)+100; obs.push({g:c, y:-50, p:false});
                if(Math.random()<0.3) pieces.push({x:c, y:-50});
            }

            obs.forEach(o=>{
                o.y+=speed; ctx.fillStyle=color; ctx.shadowBlur=15; ctx.shadowColor=color;
                ctx.fillRect(0,o.y,o.g-gap/2,30); ctx.fillRect(o.g+gap/2,o.y,600,30); ctx.shadowBlur=0;
                
                if(state==="PLAY" && o.y>ballY-20 && o.y<ballY+20 && (ballX<o.g-gap/2 || ballX>o.g+gap/2)) { 
                    state="HUB"; document.getElementById('screen-hub').classList.add('active-screen'); 
                    if(currentLvl==='INF' && score>record) record=score; 
                    sync(); 
                }
                if(o.y>ballY && !o.p){ o.p=true; score++; if(currentLvl!=='INF' && score>=20){state="CINEMATIC"; reached++; coins+=100; sync();}}
            });

            pieces.forEach((p,i)=>{ p.y+=speed; ctx.font="20px Arial"; ctx.fillText("ðŸª™",p.x-10,p.y); if(Math.hypot(p.x-ballX,p.y-ballY)<35){pieces.splice(i,1); coins+=5; sync();}});
            
            ctx.fillStyle=ballColor; ctx.shadowBlur=20; ctx.shadowColor=ballColor;
            ctx.beginPath(); ctx.arc(ballX, ballY, 22, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
            
            ctx.fillStyle="#fff"; ctx.font="900 80px Orbitron"; ctx.textAlign="center"; ctx.fillText(score, 300, 160);
        } requestAnimationFrame(loop);
    } loop();
</script>
</body>
</html>
