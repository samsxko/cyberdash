<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - THE FINISH LINE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        body { background: #020205; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        #left-col, #right-col { width: 260px; border: 1px solid #ffffff22; background: #000; display: flex; flex-direction: column; z-index: 10; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }

        /* ADMIN */
        #admin-panel { padding: 15px; display: none; background: #1a0000; border-bottom: 2px solid #ff3131; }
        .admin-info { margin-bottom: 10px; color: #ff3131; font-family: monospace; font-size: 11px; }

        /* BOUTIQUE */
        #shop { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .shop-item { display: flex; justify-content: space-between; border: 1px solid #ffffff22; padding: 10px; margin-bottom: 5px; font-size: 10px; cursor: pointer; }
        .owned { border-color: #00f2ff; color: #00f2ff; }

        /* JEU */
        #container { height: 95vh; aspect-ratio: 9/16; position: relative; border: 2px solid #ffffff44; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; }

        /* BOUTONS L R */
        .m-btn { display: none; position: absolute; bottom: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border: 2px solid #fff; border-radius: 50%; z-index: 500; justify-content: center; align-items: center; color: #fff; font-size: 24px; box-shadow: 0 0 15px #fff; }
        #btn-L { left: 20px; } #btn-R { right: 20px; }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 100; text-align: center; }
        .active { display: flex !important; }

        /* CINEMATIQUE ETOILES */
        .star-container { font-size: 50px; color: #ffd700; margin: 20px 0; text-shadow: 0 0 20px #ffd700; }
        .star { display: inline-block; animation: pop 0.5s forwards; opacity: 0; scale: 0; }
        @keyframes pop { to { opacity: 1; scale: 1.2; } }
    </style>
</head>
<body>

    <div id="left-col">
        <div style="padding:15px; text-align:center; font-weight:900; border-bottom:1px solid #222;">üèÜ RECORDS</div>
        <div id="leaderboard" style="padding:10px; font-size:11px; flex-grow:1;"></div>
        <a href="https://www.paypal.me/frsaamya" target="_blank" style="color:#fff; text-decoration:none; font-size:10px; border:1px solid #fff; margin:15px; padding:10px; text-align:center;">PAYPAL ‚òï</a>
    </div>

    <div id="game-col">
        <div id="container">
            <div id="btn-L" class="m-btn">L</div>
            <div id="btn-R" class="m-btn">R</div>

            <div id="screen-login" class="screen active">
                <h1 style="font-size:30px;">CYBER DASH</h1>
                <input type="text" id="nick" placeholder="PSEUDO..." style="margin-top:20px; padding:10px; background:none; border:1px solid #fff; color:#fff; text-align:center; font-family:'Orbitron';">
                <div onclick="init()" style="border:1px solid #fff; padding:10px 30px; margin-top:20px; cursor:pointer;">START</div>
            </div>

            <div id="screen-hub" class="screen">
                <div id="stats" style="color:#00f2ff; margin-bottom:10px;">POINTS: 0</div>
                <div id="lvls" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
                <div onclick="start('INF')" style="border:1px solid #00f2ff; padding:10px 30px; margin-top:20px; cursor:pointer; color:#00f2ff;">INFINI</div>
            </div>

            <div id="screen-win" class="screen" style="background:rgba(255,255,255,0.1); backdrop-filter:blur(10px);">
                <h2 style="letter-spacing:5px;">NIVEAU R√âUSSI</h2>
                <div class="star-container">
                    <span class="star" style="animation-delay: 0.2s;">‚òÖ</span>
                    <span class="star" style="animation-delay: 0.4s;">‚òÖ</span>
                    <span class="star" style="animation-delay: 0.6s;">‚òÖ</span>
                </div>
                <div onclick="location.reload()" style="border:1px solid #fff; padding:10px 30px; cursor:pointer;">SUIVANT</div>
            </div>

            <canvas id="cvs"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div onclick="goAdmin()" style="padding:15px; color:#ff3131; cursor:pointer; text-align:center; font-size:12px;">üõ∞Ô∏è ADMIN</div>
        <div id="admin-panel">
            <div id="admin-stats" class="admin-info"></div>
            <button onclick="addPoints(1000)" style="width:100%; margin-bottom:5px;">+1000 PTS</button>
            <button onclick="unlockAll()" style="width:100%;">UNLOCK ALL</button>
        </div>
        <div id="shop">
            <div style="text-align:center; font-size:12px; margin-bottom:10px;">BOUTIQUE</div>
            <div id="shop-items"></div>
            <div id="current-pts" style="text-align:center; margin-top:20px;">0 PTS</div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const cvs = document.getElementById("cvs");
    const ctx = cvs.getContext("2d");
    cvs.width = 600; cvs.height = 1000;

    let user = "", ip = "", points = 0, record = 0, reached = 1, admin = false, currentLvl = 0;
    let ballX = 300, ballY = 750, obs = [], keys = {}, state = "LOGIN", score = 0, finishY = -200;

    function goAdmin() { 
        if(prompt("CODE:") === "2011") { 
            admin = true; document.getElementById('admin-panel').style.display = 'block';
            setInterval(() => { document.getElementById('admin-stats').innerHTML = `TIME: ${new Date().toLocaleTimeString()}<br>IP: ${ip}`; }, 1000);
        } 
    }
    function addPoints(n) { points += n; db.ref('users/'+ip).update({points}); }
    function unlockAll() { reached = 9; db.ref('users/'+ip).update({reached:9}); }

    function init() {
        user = document.getElementById('nick').value.toUpperCase(); if(!user) return;
        document.getElementById('screen-login').classList.remove('active');
        document.getElementById('screen-hub').classList.add('active');
        fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{
            ip = d.ip.replace(/\./g, '_');
            db.ref('users/'+ip).on('value', s=>{
                const v = s.val()||{}; points=v.points||0; record=v.record||0; reached=v.reached||1;
                document.getElementById('current-pts').innerText = points + " PTS";
                renderLvls();
            });
        });
    }

    function renderLvls() {
        let h = ""; for(let i=1; i<=9; i++) { h += `<div onclick="if(${i<=reached}) start(${i})" style="border:1px solid #fff; padding:10px; text-align:center; opacity:${i<=reached?1:0.2}">${i}</div>`; }
        document.getElementById('lvls').innerHTML = h;
    }

    function start(l) { currentLvl = l; state="PLAY"; score=0; obs=[]; ballX=300; ballY=750; document.getElementById('screen-hub').classList.remove('active'); }

    // CONTROLES
    window.onkeydown = e => { if(e.key==="ArrowLeft") keys["L"]=true; if(e.key==="ArrowRight") keys["R"]=true; };
    window.onkeyup = e => { if(e.key==="ArrowLeft") keys["L"]=false; if(e.key==="ArrowRight") keys["R"]=false; };
    document.getElementById('btn-L').ontouchstart = (e) => { e.preventDefault(); keys["L"]=true; };
    document.getElementById('btn-L').ontouchend = () => { keys["L"]=false; };
    document.getElementById('btn-R').ontouchstart = (e) => { e.preventDefault(); keys["R"]=true; };
    document.getElementById('btn-R').ontouchend = () => { keys["R"]=false; };

    function loop() {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);

        if(state === "PLAY") {
            if(keys["L"]) ballX -= 12; if(keys["R"]) ballX += 12;
            ballX = Math.max(30, Math.min(570, ballX));

            // GENERATION MURS
            if(score < 15 && Math.random() < 0.04) obs.push({g: Math.random()*250+175, y: -50, p: false});
            
            obs.forEach(o => {
                o.y += 7;
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.shadowBlur = 15; ctx.shadowColor = "#00f2ff";
                ctx.strokeRect(-5, o.y, o.g-130, 20); ctx.strokeRect(o.g+130, o.y, 610, 20);
                if(o.y > ballY-20 && o.y < ballY+20 && (ballX < o.g-115 || ballX > o.g+115)) {
                    state = "HUB"; document.getElementById('screen-hub').classList.add('active');
                }
                if(o.y > ballY && !o.p) { o.p = true; score++; }
            });

            // FIN DU NIVEAU : La balle monte
            if(currentLvl !== 'INF' && score >= 15) {
                ballY -= 5; // La balle monte vers la lumi√®re
                // Lumi√®re de fin
                let grad = ctx.createRadialGradient(300, 0, 0, 300, 0, 400);
                grad.addColorStop(0, "white"); grad.addColorStop(1, "transparent");
                ctx.fillStyle = grad; ctx.fillRect(0,0,600,400);

                if(ballY < 50) {
                    state = "WIN";
                    document.getElementById('screen-win').classList.add('active');
                    if(currentLvl === reached) db.ref('users/'+ip).update({reached: reached + 1});
                    db.ref('users/'+ip).update({points: points + 100});
                }
            }

            // DESSIN BALLE
            ctx.fillStyle = "#fff"; ctx.shadowBlur = 15; ctx.shadowColor = "#fff";
            ctx.beginPath(); ctx.arc(ballX, ballY, 22, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = "#fff"; ctx.font = "900 60px Orbitron"; ctx.textAlign = "center";
            ctx.fillText(score, 300, 150);
        }
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
