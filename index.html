<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - FINAL EDITION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body { margin: 0; background: #020205; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #app-container { width: 100%; max-width: 500px; height: 95vh; position: relative; border: 3px solid #00f2ff; background: #000; overflow: hidden; box-shadow: 0 0 20px rgba(0,242,255,0.2); transition: border-color 0.5s; }
        .page { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; z-index: 5; }
        .active { display: flex; }
        input { background: rgba(255,255,255,0.05); border: 2px solid #00f2ff; color: #fff; padding: 15px; font-family: 'Orbitron'; font-size: 18px; text-align: center; width: 90%; outline: none; margin-bottom: 20px; text-transform: uppercase; }
        .btn { border: 2px solid #00f2ff; padding: 18px 30px; cursor: pointer; text-transform: uppercase; font-weight: 900; background: rgba(0, 242, 255, 0.05); color: #00f2ff; width: 90%; margin: 10px 0; transition: 0.2s; letter-spacing: 2px; }
        .btn:active { transform: scale(0.95); background: #00f2ff; color: #000; }
        #info-bar { position: absolute; top: 15px; left: 15px; font-size: 10px; color: #00f2ff; z-index: 10; text-align: left; line-height: 1.4; pointer-events: none; }
        canvas { width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="info-bar">IDENT: <span id="user-ip">...</span><br>PROGRESSION: NIV.<span id="user-reach">1</span></div>

    <div id="page-login" class="page active">
        <h1 style="color:#00f2ff; font-size: 35px; margin-bottom: 10px; font-weight: 900;">CYBER DASH</h1>
        <p style="font-size: 12px; letter-spacing: 2px; margin-bottom: 30px; opacity: 0.7;">AUTH_REQUIRED</p>
        <input type="text" id="pseudoInput" placeholder="PSEUDO_PILOTE" maxlength="10">
        <div class="btn" onclick="validateLogin()">INITIALISER</div>
    </div>

    <div id="page-hub" class="page">
        <h2 id="welcome-msg" style="font-size: 20px; color: #fff; margin-bottom: 40px;">READY?</h2>
        <div class="btn" onclick="startMode('SAGA')">AVENTURE : NIV.<span id="btn-next-lvl">1</span></div>
        <div class="btn" onclick="startMode('INFINITE')" style="border-color:#ff00ff; color:#ff00ff;">MODE INFINI</div>
        <p style="font-size: 10px; margin-top: 40px; opacity: 0.5;">CLIQUEZ À GAUCHE OU À DROITE POUR DIRIGER</p>
    </div>

    <div id="page-game" class="page" style="padding:0;">
        <canvas id="gameCanvas"></canvas>
    </div>
</div>

<script>
    // CONFIGURATION FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 600; canvas.height = 1000;

    let pseudo = "", reachedLevel = 1, userIP = "", state = "LOGIN", score = 0;
    let ballX = 300, obstacles = [], items = [], keys = {}, themeColor = "#00f2ff";

    // DETECTION IP ET SYNC NIVEAU
    fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
        userIP = d.ip.replace(/\./g, '_');
        document.getElementById('user-ip').innerText = d.ip;
        db.ref('users/' + userIP).on('value', snap => {
            if(snap.exists()) {
                reachedLevel = snap.val().reached || 1;
                document.getElementById('user-reach').innerText = reachedLevel;
                document.getElementById('btn-next-lvl').innerText = reachedLevel;
                applyTheme(reachedLevel);
            }
        });
    });

    function applyTheme(lvl) {
        if(lvl <= 5) themeColor = "#00f2ff";
        else if(lvl <= 10) themeColor = "#39ff14";
        else if(lvl <= 15) themeColor = "#bc13fe";
        else themeColor = "#ff3131";
        document.getElementById('app-container').style.borderColor = themeColor;
        document.getElementById('info-bar').style.color = themeColor;
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function validateLogin() {
        let val = document.getElementById('pseudoInput').value;
        if(val.length >= 3) {
            pseudo = val.toUpperCase();
            document.getElementById('welcome-msg').innerText = "PILOTE : " + pseudo;
            showPage('page-hub');
            state = "HUB";
        } else { alert("NOM REQUIS (3 CARACTÈRES MIN.)"); }
    }

    function startMode(mode) {
        state = mode; score = 0; obstacles = []; items = []; ballX = 300;
        showPage('page-game');
    }

    // CONTROLES PC & TACTILE
    window.addEventListener("keydown", e => keys[e.code] = true);
    window.addEventListener("keyup", e => keys[e.code] = false);

    canvas.addEventListener("touchstart", e => {
        const tx = e.touches[0].clientX;
        if(tx < window.innerWidth/2) keys["ArrowLeft"] = true; else keys["ArrowRight"] = true;
    }, {passive: false});
    canvas.addEventListener("touchend", () => { keys["ArrowLeft"] = false; keys["ArrowRight"] = false; });

    function gameLoop() {
        if(state === "SAGA" || state === "INFINITE") {
            ctx.fillStyle = "#020205"; ctx.fillRect(0,0,600,1000);
            
            // Mouvement
            if(keys["ArrowLeft"] || keys["KeyA"] || keys["KeyQ"]) ballX -= 14;
            if(keys["ArrowRight"] || keys["KeyD"]) ballX += 14;
            ballX = Math.max(40, Math.min(560, ballX));

            let speed = 7 + (reachedLevel * 0.45);

            // Obstacles (Passage de 180px pour la fidélité)
            if(Math.random() < 0.045) {
                obstacles.push({gap: Math.random()*360+120, y: -50, hit: false});
            }

            // Bonus +5
            if(Math.random() < 0.01) {
                items.push({x: Math.random()*500+50, y: -50, collected: false});
            }

            // Draw Items
            items.forEach((it, i) => {
                it.y += speed;
                ctx.fillStyle = "#fff"; ctx.shadowBlur = 15; ctx.shadowColor = themeColor;
                ctx.beginPath();
                ctx.moveTo(it.x, it.y-15); ctx.lineTo(it.x+15, it.y);
                ctx.lineTo(it.x, it.y+15); ctx.lineTo(it.x-15, it.y);
                ctx.fill();
                if(Math.hypot(ballX - it.x, 900 - it.y) < 45) { it.collected = true; score += 5; items.splice(i,1); }
            });

            // Draw Obstacles
            obstacles.forEach(o => {
                o.y += speed;
                ctx.fillStyle = themeColor; ctx.shadowBlur = 15; ctx.shadowColor = themeColor;
                ctx.fillRect(0, o.y, o.gap-90, 35);
                ctx.fillRect(o.gap+90, o.y, 600, 35);

                if(o.y > 880 && o.y < 915 && (ballX < o.gap-75 || ballX > o.gap+75)) {
                    state = "HUB"; showPage('page-hub');
                }
                if(o.y > 1000 && !o.hit) {
                    o.hit = true; score++;
                    if(state === "SAGA" && score >= reachedLevel * 100) {
                        reachedLevel++;
                        db.ref('users/' + userIP).update({reached: reachedLevel});
                        state = "HUB"; showPage('page-hub');
                    }
                }
            });

            obstacles = obstacles.filter(o => o.y < 1100);
            items = items.filter(it => it.y < 1100);

            // Balle
            ctx.shadowBlur = 20; ctx.shadowColor = "#fff"; ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(ballX, 900, 22, 0, Math.PI*2); ctx.fill();
            
            // Score UI
            ctx.shadowBlur = 0; ctx.textAlign = "left"; ctx.font = "900 50px Orbitron";
            ctx.fillStyle = themeColor; ctx.fillText(score, 40, 90);
            ctx.font = "12px Orbitron"; ctx.fillText("OBJECTIF: " + (reachedLevel*100), 40, 120);
        }
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>
