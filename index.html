<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - FINAL EDITION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        body { background: #010105; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- FENÃŠTRES LATÃ‰RALES (REPARÃ‰ES) --- */
        #left-col, #right-col { 
            width: 270px; border: 2px solid #ffffff22; background: rgba(10, 10, 25, 0.9); 
            margin: 10px; border-radius: 15px; display: flex; flex-direction: column; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
        }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }

        .panel-title { padding: 15px; background: rgba(255,255,255,0.05); color: #00f2ff; text-align: center; font-weight: 900; border-bottom: 1px solid #ffffff22; letter-spacing: 1px; }
        #leaderboard { flex-grow: 1; padding: 10px; font-size: 11px; overflow-y: auto; color: #00f2ff; }
        
        /* --- SHOP --- */
        #shop { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .shop-item { 
            background: #000; border: 1px solid #ffffff22; padding: 10px; margin-bottom: 8px; 
            border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; font-size: 10px; transition: 0.2s;
        }
        .shop-item.owned { border-color: #00f2ff; color: #00f2ff; font-weight: 900; }

        /* --- ZONE DE JEU --- */
        #container { height: 94vh; aspect-ratio: 9/16; position: relative; border: 3px solid #fff; background: #000; overflow: hidden; box-shadow: 0 0 30px rgba(255,255,255,0.1); }
        canvas { width: 100%; height: 100%; }

        /* --- BOUTONS MOBILES (BLANCS QUI S'INTENSIFIENT) --- */
        .m-btn { 
            display: none; position: absolute; bottom: 40px; width: 85px; height: 85px; 
            background: rgba(255,255,255,0.1); border: 3px solid #fff; 
            border-radius: 50%; z-index: 500; justify-content: center; align-items: center; 
            font-weight: 900; color: #fff; font-size: 24px; box-shadow: 0 0 15px #fff; transition: 0.1s;
        }
        .m-btn.active { background: #fff; color: #000; box-shadow: 0 0 50px #fff; transform: scale(1.1); }
        #btn-L { left: 20px; } #btn-R { right: 20px; }

        /* --- ECRANS --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 100; text-align: center; padding: 20px; }
        .active-screen { display: flex !important; }
        .btn-ui { border: 2px solid #fff; padding: 12px 30px; color: #fff; cursor: pointer; font-weight: 900; margin-top: 20px; text-transform: uppercase; }
        .btn-ui:hover { background: #fff; color: #000; }

        /* --- ETOILES --- */
        .star-box { margin: 20px; display: flex; gap: 15px; }
        .star { font-size: 50px; color: #ffd700; opacity: 0; transform: scale(0); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .star.pop { opacity: 1; transform: scale(1.2); text-shadow: 0 0 20px #ffd700; }

        @media (max-width: 1000px) { #left-col, #right-col { display: none; } #container { width: 100vw; height: 100vh; border: none; } .m-btn { display: flex; } }
    </style>
</head>
<body>

    <div id="left-col">
        <div class="panel-title">CLASSEMENT</div>
        <div id="leaderboard">Chargement...</div>
    </div>

    <div id="game-col">
        <div id="container">
            <div id="btn-L" class="m-btn">L</div>
            <div id="btn-R" class="m-btn">R</div>

            <div id="screen-login" class="screen active-screen">
                <h1 style="font-size:32px; letter-spacing:4px;">CYBER DASH</h1>
                <input type="text" id="nick" placeholder="PSEUDO..." maxlength="12" style="margin-top:20px; padding:12px; background:none; border:2px solid #fff; color:#fff; text-align:center; font-family:'Orbitron'; outline:none; width:80%;">
                <div class="btn-ui" onclick="init()">JOUER</div>
            </div>

            <div id="screen-hub" class="screen">
                <div id="hub-stats" style="color:#00f2ff; margin-bottom:15px; font-size:14px;"></div>
                <div id="lvls" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
                <div class="btn-ui" onclick="start('INF')" style="color:#00f2ff; border-color:#00f2ff;">MODE INFINI</div>
            </div>

            <div id="screen-win" class="screen">
                <h2 style="font-size:24px;">NIVEAU RÃ‰USSI !</h2>
                <div class="star-box">
                    <span class="star" id="s1">â˜…</span><span class="star" id="s2">â˜…</span><span class="star" id="s3">â˜…</span>
                </div>
                <div class="btn-ui" onclick="location.reload()">CONTINUER</div>
            </div>

            <canvas id="cvs"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div class="panel-title">BOUTIQUE</div>
        <div id="shop">
            <div id="shop-items"></div>
        </div>
        <div id="user-coins" style="text-align:center; color:#ffd700; font-weight:900; padding:15px; border-top:1px solid #222; font-size:18px;">0 ðŸª™</div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const cvs = document.getElementById("cvs");
    const ctx = cvs.getContext("2d");
    cvs.width = 600; cvs.height = 1000;

    let user = "", ip = "", coins = 0, record = 0, reached = 1, currentLvl = 1;
    let ballX = 300, ballY = 750, obs = [], pieces = [], keys = {}, state = "LOGIN", score = 0;
    let ballColor = "#fff", owned = ["#fff"];

    function sync() { db.ref('users/'+ip).update({coins, record, reached, owned, ballColor, user}); }

    function init() {
        user = document.getElementById('nick').value.toUpperCase(); if(!user) return;
        document.getElementById('screen-login').classList.remove('active-screen');
        document.getElementById('screen-hub').classList.add('active-screen');
        fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{
            ip = d.ip.replace(/\./g, '_');
            db.ref('users/'+ip).on('value', s=>{
                const v = s.val()||{}; coins=v.coins||0; record=v.record||0; reached=v.reached||1; owned=v.owned||["#fff"]; ballColor=v.ballColor||"#fff";
                document.getElementById('hub-stats').innerText = `BEST: ${record} | NIV. MAX: ${reached}`;
                document.getElementById('user-coins').innerText = `${coins} ðŸª™`;
                renderLvls(); renderShop();
            });
        });
        db.ref('users').orderByChild('record').limitToLast(10).on('value', s=>{
            let h = ""; s.forEach(x=>{ let p=x.val(); h=`<div style="padding:8px; border-bottom:1px solid #ffffff11;">${p.user}: ${p.record}</div>`+h; });
            document.getElementById('leaderboard').innerHTML = h;
        });
    }

    function renderShop() {
        let h = ""; [{id:"#00f2ff", n:"NEON", p:100}, {id:"#ff00ff", n:"PINK", p:300}, {id:"#ffd700", n:"GOLD", p:1000}].forEach(s => {
            const isOwned = owned.includes(s.id);
            h += `<div class="shop-item ${isOwned?'owned':''}" onclick="buy('${s.id}',${s.p})">
                <span>${s.n}</span><span>${isOwned?'OK':s.p+' ðŸª™'}</span>
            </div>`;
        });
        document.getElementById('shop-items').innerHTML = h;
    }

    function buy(id, p) {
        if(owned.includes(id)) { ballColor = id; sync(); }
        else if(coins >= p) { coins -= p; owned.push(id); ballColor = id; sync(); }
    }

    function renderLvls() {
        let h = ""; for(let i=1; i<=9; i++) { h += `<div class="btn-ui" style="
