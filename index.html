<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - MONITORING</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout : Gauche (Classement) | Centre (Jeu) | Droite (Logs larges) */
        #left-bar { width: 220px; border-right: 1px solid #00f2ff33; padding: 10px; background: #020202; }
        #game-view { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; overflow: hidden; }
        #right-bar { width: 380px; border-left: 1px solid #00f2ff33; padding: 10px; background: #020202; }

        canvas { height: 98vh; aspect-ratio: 9/16; border: 2px solid #00f2ff; background: #000; }

        .list { height: calc(100% - 50px); overflow-y: auto; scrollbar-width: none; }
        .row { padding: 10px; border-bottom: 1px solid #00f2ff11; font-size: 13px; display: flex; justify-content: space-between; }
        
        /* Style des Logs d√©taill√©s */
        .log-box { 
            padding: 10px; margin-bottom: 10px; border-left: 4px solid #bc00ff; 
            background: rgba(188, 0, 255, 0.05); font-size: 11px; line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        .log-ip { color: #888; font-size: 10px; display: block; margin-top: 4px; border-top: 1px solid #333; padding-top: 4px; }
        
        h2 { font-size: 14px; color: #00f2ff; text-align: center; border-bottom: 1px solid #00f2ff; padding-bottom: 10px; margin-top: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 1100px) { #left-bar, #right-bar { display: none; } }
    </style>
</head>
<body>

    <div id="left-bar">
        <h2>üèÜ TOP 15</h2>
        <div id="leaderboard" class="list"></div>
    </div>

    <div id="game-view">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="right-bar">
        <h2>üåê LOGS R√âSEAU</h2>
        <div id="logs" class="list"></div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
          authDomain: "cyberdash-2baf5.firebaseapp.com",
          databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "cyberdash-2baf5",
          storageBucket: "cyberdash-2baf5.firebasestorage.app",
          messagingSenderId: "360233647601",
          appId: "1:360233647601:web:60aa25f439019ed7511850"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let netInfo = { ip: "...", loc: "Localisation..." };
        fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
            netInfo.ip = d.ip;
            netInfo.loc = `${d.city}, ${d.country_name} ${d.country_emoji || ''}`;
        }).catch(() => {});

        function writeLog(user, action) {
            db.ref('logs').push({
                user: user,
                action: action,
                ip: netInfo.ip,
                loc: netInfo.loc,
                time: new Date().toLocaleTimeString()
            });
        }

        // --- CLASSEMENT LIVE ---
        db.ref('bestScores').orderByChild('score').limitToLast(15).on('value', snap => {
            let data = [];
            snap.forEach(c => data.push(c.val()));
            data.sort((a,b) => b.score - a.score);
            document.getElementById('leaderboard').innerHTML = data.map((s,i) => `
                <div class="row"><span>#${i+1} ${s.name}</span><b style="color:#00f2ff">${s.score}</b></div>
            `).join('');
        });

        // --- LOGS D√âTAILL√âS LIVE ---
        db.ref('logs').limitToLast(20).on('value', snap => {
            let html = "";
            snap.forEach(c => {
                const l = c.val();
                html = `<div class="log-box">
                    <b style="color:#bc00ff">${l.user}</b>: ${l.action}<br>
                    <span style="color:#00f2ff">üìç ${l.loc}</span>
                    <span class="log-ip">IP: ${l.ip} ‚Äî ${l.time}</span>
                </div>` + html;
            });
            document.getElementById('logs').innerHTML = html;
        });

        // --- MOTEUR DE JEU ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 600; canvas.height = 1000;

        let state = "MENU", pseudo = "", score = 0, level = 1, ballX = 300, obstacles = [], keys = {};

        function handleScore(p, s) {
            if(s < 1) return;
            const ref = db.ref('bestScores/' + p.toLowerCase().trim());
            ref.once('value', snap => {
                if(!snap.exists() || snap.val().score < s) ref.set({ name: p, score: s });
            });
        }

        window.addEventListener("keydown", e => {
            if(state === "MENU") {
                if(e.key === "Enter" && pseudo.length >= 3) { state = "PLAYING"; writeLog(pseudo, "REJOINT"); }
                else if(e.key === "Backspace") pseudo = pseudo.slice(0, -1);
                else if(e.key.length === 1 && pseudo.length < 10) pseudo += e.key.toUpperCase();
            }
            if(state === "GAMEOVER" && e.key === " ") { state = "MENU"; score = 0; level = 1; obstacles = []; ballX = 300; }
            keys[e.key] = true;
        });
        window.addEventListener("keyup", e => keys[e.key] = false);

        canvas.addEventListener("touchstart", e => {
            const rx = (e.touches[0].clientX - canvas.getBoundingClientRect().left) / canvas.clientWidth * 600;
            if(state !== "PLAYING") { if(pseudo.length >= 3) { state = "PLAYING"; writeLog(pseudo, "REJOINT"); } }
            else { if(rx < 300) keys["ArrowLeft"] = true; else keys["ArrowRight"] = true; }
        });
        canvas.addEventListener("touchend", () => { keys["ArrowLeft"] = false; keys["ArrowRight"] = false; });

        function update() {
            if(state !== "PLAYING") return;
            let spd = 8 + (level * 0.4);
            if(keys["ArrowLeft"]) ballX -= 11;
            if(keys["ArrowRight"]) ballX += 11;
            ballX = Math.max(30, Math.min(570, ballX));

            if(Math.random() < 0.05) {
                let w = Math.max(160, 420 - (level * 20));
                obstacles.push({x: Math.random()*(600-w), y: -40, w: w, hit: false});
            }

            obstacles.forEach(o => {
                o.y += spd;
                if(o.y > 880 && o.y < 915 && !(ballX > o.x && ballX < o.x + o.w)) {
                    state = "GAMEOVER";
                    writeLog(pseudo, "CRASH (Score: " + score + ")");
                    handleScore(pseudo, score);
                }
                if(o.y > 1000 && !o.hit) { o.hit = true; score++; if(score%10===0) level++; }
            });
            obstacles = obstacles.filter(o => o.y < 1100);
        }

        function draw() {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);
            if(state === "MENU") {
                ctx.textAlign = "center"; ctx.fillStyle = "#00f2ff"; ctx.font = "bold 50px Orbitron";
                ctx.fillText("CYBER DASH", 300, 400);
                ctx.fillStyle = "#fff"; ctx.font = "20px Orbitron";
                ctx.fillText("NOM: " + (pseudo || "---") + "_", 300, 500);
            } else if(state === "PLAYING") {
                ctx.fillStyle = "#00f2ff";
                obstacles.forEach(o => { ctx.fillRect(0, o.y, o.x, 30); ctx.fillRect(o.x+o.w, o.y, 600, 30); });
                ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ballX, 900, 20, 0, Math.PI*2); ctx.fill();
                ctx.font = "bold 40px Orbitron"; ctx.textAlign="left"; ctx.fillText(score, 40, 70);
            } else if(state === "GAMEOVER") {
                ctx.textAlign = "center"; ctx.fillStyle = "red"; ctx.font = "bold 60px Orbitron";
                ctx.fillText("CRASHED", 300, 450);
                ctx.fillStyle = "#fff"; ctx.font = "25px Orbitron";
                ctx.fillText("FINAL: " + score, 300, 550);
            }
            requestAnimationFrame(draw);
        }
        setInterval(update, 1000/60);
        draw();
    </script>
</body>
</html>