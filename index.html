<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; display: flex; }
        #leaderboard-side { width: 200px; border-right: 1px solid #00f2ff; padding: 10px; font-size: 12px; background: rgba(0, 242, 255, 0.05); }
        #game-container { flex-grow: 1; display: flex; justify-content: center; }
        canvas { height: 95vh; aspect-ratio: 9/16; border: 2px solid #00f2ff; margin-top: 2.5vh; }
        #hiddenInput { position: absolute; opacity: 0; pointer-events: none; }
        .rank { color: #00f2ff; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #222; padding: 3px; }
        @media (max-width: 800px) { #leaderboard-side { display: none; } }
    </style>
</head>
<body>

    <div id="leaderboard-side">
        <div style="text-align:center; color:#00f2ff; margin-bottom:10px;">üèÜ TOP 10</div>
        <div id="rankList"></div>
    </div>

    <div id="game-container">
        <input type="text" id="hiddenInput" maxlength="10">
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
            authDomain: "cyberdash-2baf5.firebaseapp.com",
            databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cyberdash-2baf5",
            storageBucket: "cyberdash-2baf5.firebasestorage.app",
            messagingSenderId: "360233647601",
            appId: "1:360233647601:web:60aa25f439019ed7511850"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const hInput = document.getElementById("hiddenInput");
        canvas.width = 600; canvas.height = 1000;

        let state = "MENU", pseudo = "", score = 0, ballX = 300, obstacles = [], keys = {};
        let userIP = "unknown";

        // R√©cup√©rer l'IP pour le tri unique
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => userIP = data.ip.replace(/\./g, '_'));

        // --- AFFICHAGE CLASSEMENT UNIQUE ---
        db.ref('leaderboard').orderByChild('score').limitToLast(10).on('value', snap => {
            let list = [];
            snap.forEach(child => { list.push(child.val()); });
            list.sort((a, b) => b.score - a.score);
            document.getElementById('rankList').innerHTML = list.map((u, i) => 
                `<div class="rank">#${i+1} ${u.name} : ${u.score}</div>`
            ).join('');
        });

        hInput.addEventListener('input', (e) => {
            if(state === "MENU") pseudo = e.target.value.toUpperCase();
        });

        window.addEventListener("keydown", e => {
            if(state === "MENU" && e.key === "Enter" && pseudo.length >= 3) state = "PLAYING";
            keys[e.key] = true;
        });
        window.addEventListener("keyup", e => keys[e.key] = false);

        canvas.addEventListener("touchstart", e => {
            const r = canvas.getBoundingClientRect();
            const tx = (e.touches[0].clientX - r.left) / r.width * 600;
            if(state === "MENU") {
                hInput.focus();
                if(pseudo.length >= 3 && tx > 200 && tx < 400) state = "PLAYING";
            } else if(state === "GAMEOVER") {
                location.reload();
            } else {
                if(tx < 300) { keys["ArrowLeft"] = true; keys["ArrowRight"] = false; }
                else { keys["ArrowRight"] = true; keys["ArrowLeft"] = false; }
            }
        });

        canvas.addEventListener("touchend", () => { keys["ArrowLeft"] = false; keys["ArrowRight"] = false; });

        function update() {
            if(state !== "PLAYING") return;
            if(keys["ArrowLeft"]) ballX -= 10;
            if(keys["ArrowRight"]) ballX += 10;
            ballX = Math.max(20, Math.min(580, ballX));

            if(Math.random() < 0.05) {
                obstacles.push({x: Math.random()*400, y: -50, w: 200});
            }

            obstacles.forEach((o, i) => {
                o.y += 8;
                if(o.y > 880 && o.y < 920 && !(ballX > o.x && ballX < o.x + o.w)) {
                    state = "GAMEOVER";
                    // ENREGISTREMENT UNIQUE PAR IP
                    const userRef = db.ref('leaderboard/' + userIP);
                    userRef.once('value', (snap) => {
                        if(!snap.exists() || snap.val().score < score) {
                            userRef.set({name: pseudo, score: score});
                        }
                    });
                }
                if(o.y > 1000) { obstacles.splice(i, 1); score++; }
            });
        }

        function draw() {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);
            if(state === "MENU") {
                ctx.fillStyle = "#00f2ff"; ctx.font = "60px Orbitron"; ctx.textAlign = "center";
                ctx.fillText("CYBER DASH", 300, 400);
                ctx.font = "25px Orbitron"; ctx.fillText("CLIQUE ICI ET TAPE TON NOM", 300, 480);
                ctx.font = "40px Orbitron"; ctx.fillText(pseudo || "____", 300, 550);
            } else if(state === "PLAYING") {
                ctx.fillStyle = "#00f2ff";
                obstacles.forEach(o => { ctx.fillRect(0, o.y, o.x, 30); ctx.fillRect(o.x+o.w, o.y, 600, 30); });
                ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ballX, 900, 20, 0, Math.PI*2); ctx.fill();
                ctx.font = "50px Orbitron"; ctx.textAlign = "left"; ctx.fillText(score, 50, 80);
            } else if(state === "GAMEOVER") {
                ctx.fillStyle = "red"; ctx.font = "60px Orbitron"; ctx.textAlign = "center";
                ctx.fillText("GAME OVER", 300, 500);
                ctx.font = "20px Orbitron"; ctx.fillStyle = "#fff"; ctx.fillText("TOUCHER POUR RECOMMENCER", 300, 580);
            }
            requestAnimationFrame(draw);
        }
        setInterval(update, 1000/60);
        draw();
    </script>
</body>
</html>
