<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body { margin: 0; background: #020205; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #left-col { width: 220px; border-right: 1px solid #00f2ff44; background: rgba(0, 242, 255, 0.02); display: flex; flex-direction: column; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; background: radial-gradient(circle, #0a0a20 0%, #020205 100%); }
        #right-col { width: 380px; border-left: 1px solid #00f2ff44; background: rgba(0, 242, 255, 0.02); display: flex; flex-direction: column; }
        #app-container { width: 100%; height: 95vh; aspect-ratio: 9/16; position: relative; border: 3px solid #00f2ff; background: #000; overflow: hidden; }
        .page { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; z-index: 10; background: rgba(0,0,0,0.9); }
        .active { display: flex; }
        input { background: rgba(255,255,255,0.05); border: 2px solid #00f2ff; color: #fff; padding: 15px; font-family: 'Orbitron'; font-size: 18px; text-align: center; width: 90%; outline: none; margin-bottom: 20px; }
        .btn { border: 2px solid #00f2ff; padding: 15px; cursor: pointer; text-transform: uppercase; font-weight: 900; background: rgba(0, 242, 255, 0.1); color: #00f2ff; width: 90%; margin: 5px 0; }
        
        /* BOUTONS L R MOBILE */
        .mobile-ctrl { display: none; position: absolute; bottom: 40px; width: 80px; height: 80px; border: 3px solid #fff; border-radius: 50%; justify-content: center; align-items: center; font-weight: 900; font-size: 30px; color: #fff; box-shadow: 0 0 15px #fff; z-index: 20; background: rgba(255,255,255,0.1); }
        #btn-L { left: 30px; }
        #btn-R { right: 30px; }
        .mobile-ctrl:active { background: #fff; color: #000; box-shadow: 0 0 30px #fff; }

        .panel-header { padding: 15px; font-size: 14px; color: #00f2ff; text-align: center; border-bottom: 1px solid #00f2ff44; }
        .scroll-list { flex-grow: 1; overflow-y: auto; scrollbar-width: none; padding: 10px; }
        .rank-card { display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: rgba(255, 255, 255, 0.05); border-left: 3px solid #00f2ff; font-size: 11px; }
        .log-card { padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 10px; border-left: 4px solid #bc00ff; background: rgba(188, 0, 255, 0.05); }
        #paypal-btn { position: absolute; bottom: 20px; background: #ffc439; color: #003087; padding: 10px 20px; border-radius: 50px; font-weight: bold; text-decoration: none; font-size: 12px; }

        @media (max-width: 1000px) { 
            #left-col, #right-col { display: none !important; } 
            .mobile-ctrl { display: flex; } /* On affiche les boutons sur mobile */
        }
    </style>
</head>
<body>

    <div id="left-col">
        <div class="panel-header">üèÜ TOP 15 WORLD</div>
        <div id="leaderboard" class="scroll-list"></div>
    </div>

    <div id="game-col">
        <div id="app-container">
            <div id="btn-L" class="mobile-ctrl">L</div>
            <div id="btn-R" class="mobile-ctrl">R</div>

            <div id="page-login" class="page active">
                <h1 style="color:#00f2ff">CYBER DASH</h1>
                <input type="text" id="pseudoInput" placeholder="PSEUDO..." maxlength="10">
                <div class="btn" onclick="validateLogin()">ENTRER</div>
                <a id="paypal-btn" href="https://paypal.me/votrelien" target="_blank">Soutenir le projet üí≥</a>
            </div>
            <div id="page-hub" class="page">
                <h2 id="welcome-msg" style="color:white">HUB</h2>
                <div class="btn" onclick="startMode('SAGA')">AVENTURE NIV.<span id="btn-next-lvl">1</span></div>
                <div class="btn" onclick="startMode('INFINITE')" style="border-color:#ff00ff; color:#ff00ff;">INFINI</div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div class="panel-header">üõ∞Ô∏è LIVE TRACKING</div>
        <div id="logs" class="scroll-list"></div>
    </div>

<script>
    // --- FIREBASE CONFIG (Inchang√©) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 600; canvas.height = 1000;

    let pseudo = "", reachedLevel = 1, userIP = "", state = "LOGIN", score = 0, ballX = 300;
    let obstacles = [], items = [], stars = [], keys = {}, themeColor = "#00f2ff";
    let lastObstacleY = 400; 

    for(let i=0; i<60; i++) stars.push({x: Math.random()*600, y: Math.random()*1000, s: Math.random()*2+1});

    // --- SYNC DATA ---
    db.ref('bestScores').on('value', snap => {
        let entries = []; snap.forEach(c => entries.push(c.val()));
        entries.sort((a,b) => b.score - a.score);
        document.getElementById('leaderboard').innerHTML = entries.slice(0, 15).map((s,i) => `
            <div class="rank-card"><span><b>#${i+1}</b> ${s.name}</span><span>${s.score}</span></div>`).join('');
    });

    db.ref('logs').limitToLast(15).on('value', snap => {
        let h = ""; snap.forEach(c => {
            const l = c.val(); let col = l.action.includes("CRASH") ? "#ff4444" : "#00ff88";
            h = `<div class="log-card" style="border-left-color:${col}"><b>${l.user}</b>: ${l.action}</div>` + h;
        });
        document.getElementById('logs').innerHTML = h;
    });

    fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
        userIP = d.ip.replace(/\./g, '_');
        db.ref('users/' + userIP).on('value', snap => {
            if(snap.exists()){
                reachedLevel = snap.val().reached || 1;
                document.getElementById('btn-next-lvl').innerText = reachedLevel;
            }
        });
    });

    // --- NAVIGATION ---
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    }

    function validateLogin() {
        let v = document.getElementById('pseudoInput').value;
        if(v.length >= 2) { pseudo = v.toUpperCase(); showPage('page-hub'); }
    }

    function startMode(m) {
        state = m; score = 0; obstacles = []; items = []; ballX = 300; lastObstacleY = 400;
        showPage(null);
        db.ref('logs').push({user: pseudo, action: "D√âPART " + m});
    }

    // --- CONTROLES ---
    window.addEventListener("keydown", e => keys[e.code] = true);
    window.addEventListener("keyup", e => keys[e.code] = false);

    // Gestion Boutons Tactiles
    const bL = document.getElementById('btn-L');
    const bR = document.getElementById('btn-R');

    bL.addEventListener('touchstart', (e) => { e.preventDefault(); keys["ArrowLeft"] = true; });
    bL.addEventListener('touchend', () => { keys["ArrowLeft"] = false; });
    bR.addEventListener('touchstart', (e) => { e.preventDefault(); keys["ArrowRight"] = true; });
    bR.addEventListener('touchend', () => { keys["ArrowRight"] = false; });

    // --- LOOP ---
    function gameLoop() {
        ctx.fillStyle = "#020205"; ctx.fillRect(0,0,600,1000);
        stars.forEach(s => { 
            s.y += 1.2; if(s.y > 1000) s.y = 0;
            ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.fillRect(s.x, s.y, s.s, s.s);
        });

        if(state === "SAGA" || state === "INFINITE") {
            if(keys["ArrowLeft"] || keys["KeyA"] || keys["KeyQ"]) ballX -= 10;
            if(keys["ArrowRight"] || keys["KeyD"]) ballX += 10;
            ballX = Math.max(40, Math.min(560, ballX));

            let speed = 6 + (reachedLevel * 0.4);

            if(Math.random() < 0.05 && lastObstacleY > 320) {
                obstacles.push({gap: Math.random()*300+150, y: -50, hit: false});
                lastObstacleY = 0;
            }
            lastObstacleY += speed;

            if(Math.random() < 0.01) items.push({x: Math.random()*500+50, y: -50});

            items.forEach((it, i) => {
                it.y += speed;
                ctx.fillStyle = "#fff"; ctx.shadowBlur = 15; ctx.shadowColor = "#00f2ff";
                ctx.beginPath(); ctx.arc(it.x, it.y, 12, 0, Math.PI*2); ctx.fill();
                if(Math.hypot(ballX - it.x, 900 - it.y) < 45) { score += 5; items.splice(i,1); }
            });

            obstacles.forEach(o => {
                o.y += speed;
                ctx.fillStyle = (reachedLevel > 5) ? "#39ff14" : "#00f2ff";
                ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
                ctx.fillRect(0, o.y, o.gap-110, 35); 
                ctx.fillRect(o.gap+110, o.y, 600, 35);

                if(o.y > 880 && o.y < 918 && (ballX < o.gap-95 || ballX > o.gap+95)) {
                    db.ref('logs').push({user: pseudo, action: "CRASH ("+score+")"});
                    if(state === "INFINITE") db.ref('bestScores/'+userIP).set({name: pseudo, score: score});
                    state = "HUB"; showPage('page-hub');
                }
                if(o.y > 1000 && !o.hit) {
                    o.hit = true; score++;
                    if(state === "SAGA" && score >= reachedLevel * 100) {
                        reachedLevel++;
                        db.ref('users/' + userIP).update({reached: reachedLevel});
                        state = "HUB"; showPage('page-hub');
                    }
                }
            });

            ctx.shadowBlur = 20; ctx.shadowColor = "#fff"; ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(ballX, 900, 22, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0; ctx.font = "900 60px Orbitron"; ctx.fillText(score, 40, 90);
        }
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>
