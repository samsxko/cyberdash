<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - SAGA FIXED</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body { margin: 0; background: #020205; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #left-col, #right-col { width: 250px; border: 1px solid #00f2ff33; background: rgba(0, 242, 255, 0.02); display: flex; flex-direction: column; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        canvas { height: 95vh; aspect-ratio: 9/16; border: 2px solid #00f2ff; background: #000; box-shadow: 0 0 20px #00f2ff55; }
        .panel-header { padding: 15px; font-size: 14px; color: #00f2ff; text-align: center; border-bottom: 1px solid #00f2ff44; }
        .scroll { flex-grow: 1; overflow-y: auto; padding: 10px; scrollbar-width: none; }
        .card { padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-left: 3px solid #00f2ff; font-size: 11px; }
        .btn-pay { margin: 10px; padding: 12px; background: #ffc439; color: #003087; text-align: center; border-radius: 5px; font-weight: 900; text-decoration: none; }
        @media (max-width: 1000px) { #left-col, #right-col { display: none !important; } canvas { width: 100vw; height: 100vh; border: none; } }
    </style>
</head>
<body>

    <div id="left-col">
        <div class="panel-header">üèÜ CLASSEMENT</div>
        <div id="leaderboard" class="scroll"></div>
        <a href="https://paypal.me/frsaamya" target="_blank" class="btn-pay">‚òï PAYPAL</a>
    </div>

    <div id="game-col">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="right-col">
        <div class="panel-header">üõ∞Ô∏è LIVE TRACKING</div>
        <div id="logs" class="scroll"></div>
    </div>

<script>
    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0",
        authDomain: "cyberdash-2baf5.firebaseapp.com",
        databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cyberdash-2baf5",
        storageBucket: "cyberdash-2baf5.firebasestorage.app",
        messagingSenderId: "360233647601",
        appId: "1:360233647601:web:60aa25f439019ed7511850"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 600; canvas.height = 1000;

    let state = "MENU", pseudo = "", score = 0, ballX = 300, obstacles = [], stars = [], keys = {};
    let userIP = "temp_" + Math.floor(Math.random()*1000);
    let reachedLevel = 1;

    // --- R√âCUP√âRATION DATA ---
    fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
        userIP = d.ip.replace(/\./g, '_');
        db.ref('users/' + userIP + '/reached').on('value', snap => {
            if(snap.exists()) reachedLevel = snap.val();
        });
    });

    db.ref('bestScores').on('value', snap => {
        let items = []; snap.forEach(c => items.push(c.val()));
        items.sort((a,b) => b.score - a.score);
        document.getElementById('leaderboard').innerHTML = items.slice(0,10).map(s => `<div class="card"><b>${s.name}</b>: ${s.score}</div>`).join('');
    });

    db.ref('logs').limitToLast(10).on('value', snap => {
        let h = ""; snap.forEach(c => { h = `<div class="card">${c.val().user}: ${c.val().action}</div>` + h; });
        document.getElementById('logs').innerHTML = h;
    });

    // --- LOGIQUE JEU ---
    function askPseudo() {
        if(!pseudo) {
            let p = prompt("ENTRE TON PSEUDO :");
            if(p && p.length >= 2) {
                pseudo = p.toUpperCase();
                db.ref('logs').push({user: pseudo, action: "Connect√©", time: new Date().toLocaleTimeString()});
            }
        }
    }

    canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        askPseudo();
        const rect = canvas.getBoundingClientRect();
        const tx = (e.touches[0].clientX - rect.left) / rect.width * 600;
        const ty = (e.touches[0].clientY - rect.top) / rect.height * 1000;

        if(state === "MENU" && pseudo) {
            if(ty > 400 && ty < 600) { state = "PLAYING"; score = 0; obstacles = []; }
        } else {
            if(tx < 300) keys["Left"] = true; else keys["Right"] = true;
        }
    });

    canvas.addEventListener("touchend", () => { keys = {}; });

    function draw() {
        ctx.fillStyle = "#020205"; ctx.fillRect(0,0,600,1000);
        
        // Etoiles
        ctx.fillStyle = "#fff";
        if(stars.length < 50) stars.push({x: Math.random()*600, y: 0, s: Math.random()*2});
        stars.forEach((s, i) => {
            s.y += 2;
            ctx.fillRect(s.x, s.y, s.s, s.s);
            if(s.y > 1000) stars.splice(i, 1);
        });

        if(state === "MENU") {
            ctx.textAlign = "center"; ctx.fillStyle = "#00f2ff"; ctx.font = "bold 60px Orbitron";
            ctx.fillText("CYBER DASH", 300, 300);
            ctx.font = "20px Orbitron";
            ctx.fillText(pseudo ? "PLAYER: " + pseudo : "TOUCHE POUR COMMENCER", 300, 420);
            if(pseudo) {
                ctx.strokeStyle = "#00f2ff"; ctx.lineWidth = 3;
                ctx.strokeRect(150, 470, 300, 80);
                ctx.fillText("JOUER NIVEAU " + reachedLevel, 300, 520);
                ctx.font = "12px Orbitron";
                ctx.fillText("OBJECTIF: " + (reachedLevel * 100) + " PTS", 300, 580);
            }
        } else {
            updateGame();
        }
        requestAnimationFrame(draw);
    }

    function updateGame() {
        if(keys["Left"]) ballX -= 12; if(keys["Right"]) ballX += 12;
        ballX = Math.max(30, Math.min(570, ballX));

        let speed = 7 + (reachedLevel * 0.5);
        let goal = reachedLevel * 100;

        if(Math.random() < 0.05) {
            obstacles.push({y: -50, gap: Math.random()*400 + 100, hit: false});
        }

        obstacles.forEach((o, i) => {
            o.y += speed;
            ctx.fillStyle = "#00f2ff"; ctx.shadowBlur = 10; ctx.shadowColor = "#00f2ff";
            ctx.fillRect(0, o.y, o.gap - 50, 35);
            ctx.fillRect(o.gap + 50, o.y, 600, 35);
            ctx.shadowBlur = 0;

            // Collision
            if(o.y > 880 && o.y < 915 && (ballX < o.gap - 40 || ballX > o.gap + 40)) {
                db.ref('logs').push({user: pseudo, action: "Crash Niv "+reachedLevel+" √† "+score});
                state = "MENU";
            }
            // Score
            if(o.y > 1000 && !o.hit) {
                o.hit = true; score++;
                if(score >= goal) {
                    reachedLevel++;
                    db.ref('users/' + userIP + '/reached').set(reachedLevel);
                    db.ref('bestScores/' + userIP).set({name: pseudo, score: score});
                    state = "MENU";
                }
            }
        });
        obstacles = obstacles.filter(o => o.y < 1100);

        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ballX, 900, 22, 0, Math.PI*2); ctx.fill();
        ctx.font = "bold 50px Orbitron"; ctx.textAlign = "left";
        ctx.fillText(score, 40, 80);
    }

    draw();
</script>
</body>
</html>
