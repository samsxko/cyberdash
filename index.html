<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CYBER DASH - MOBILE FIX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        body { background: #000; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; height: 100vh; overflow: hidden; flex-direction: row; }
        
        /* LAYOUT PC */
        #left-col, #right-col { width: 320px; border: 1px solid #ffffff22; background: #05050f; margin: 10px; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; z-index: 10; }
        #game-col { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
        
        /* TABS MOBILE (Cach√©s sur PC) */
        #mobile-nav { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #0a0a1a; z-index: 1000; border-bottom: 2px solid #00f2ff; justify-content: space-around; align-items: center; }
        .nav-item { font-size: 12px; font-weight: 900; color: #fff; opacity: 0.5; padding: 10px; }
        .nav-item.active { opacity: 1; color: #00f2ff; border-bottom: 2px solid #00f2ff; }

        .panel-title { padding: 20px; text-align: center; font-weight: 900; border-bottom: 2px solid #ffffff11; color: #00f2ff; }
        #container { height: 92vh; aspect-ratio: 9/16; position: relative; border: 4px solid #fff; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        .scroll-zone { flex-grow: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .item-card { background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ffffff11; }
        .buy-btn { background: #00f2ff; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: 900; font-size: 10px; }
        .buy-btn.equipped { background: #fff; }

        /* MOBILE OVERRIDES */
        @media (max-width: 1000px) {
            body { flex-direction: column; }
            #mobile-nav { display: flex; }
            #left-col, #right-col, #game-col { 
                position: absolute; top: 60px; left: 0; right: 0; bottom: 0; 
                width: 100%; margin: 0; border: none; border-radius: 0; display: none; 
            }
            .active-tab { display: flex !important; }
            #container { height: 100%; width: 100%; aspect-ratio: auto; border: none; }
            .m-btn { display: flex !important; }
        }

        /* BOUTONS MOBILES */
        .m-btn { display: none; position: absolute; bottom: 30px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; z-index: 500; justify-content: center; align-items: center; font-weight: 900; font-size: 20px; }
        #btn-L { left: 20px; } #btn-R { right: 20px; }

        /* SCREENS */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 100; text-align: center; }
        .active-screen { display: flex !important; }
        .btn-ui { border: 2px solid #fff; padding: 15px 30px; color: #fff; font-weight: 900; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="mobile-nav">
        <div class="nav-item" onclick="switchTab('left-col', this)">CLASSEMENT</div>
        <div class="nav-item active" onclick="switchTab('game-col', this)">JEU</div>
        <div class="nav-item" onclick="switchTab('right-col', this)">BOUTIQUE</div>
    </div>

    <div id="left-col">
        <div class="panel-title">CLASSEMENT</div>
        <div id="leaderboard" class="scroll-zone"></div>
        <div style="background:#003087; padding:15px; text-align:center; font-size:10px;" onclick="window.open('https://paypal.me/frsaamya')">DONATION ‚ù§Ô∏è</div>
    </div>

    <div id="game-col" class="active-tab">
        <div id="container">
            <div id="btn-L" class="m-btn">L</div><div id="btn-R" class="m-btn">R</div>
            <div id="screen-login" class="screen active-screen">
                <h1 style="color:#00f2ff">CYBER DASH</h1>
                <input type="text" id="nick" placeholder="PSEUDO..." maxlength="10" style="margin:20px; padding:12px; background:none; border:2px solid #fff; color:#fff; text-align:center; font-family:'Orbitron';">
                <div class="btn-ui" onclick="init()">START</div>
            </div>
            <div id="screen-hub" class="screen">
                <div id="hub-stats" style="color:#00f2ff; margin-bottom:10px;"></div>
                <div id="lvls" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
                <div class="btn-ui" style="background:#ff007f; border:none;" onclick="start('INF')">MODE INFINI</div>
            </div>
            <canvas id="cvs"></canvas>
        </div>
    </div>

    <div id="right-col">
        <div class="panel-title" ondblclick="toggleAdmin()">BOUTIQUE</div>
        <div id="shop" class="scroll-zone"></div>
        <div id="user-coins" style="text-align:center; padding:10px; color:#ffd700; font-weight:900;">0 ü™ô</div>
        <div style="background:#ffc439; color:#003087; padding:15px; text-align:center; font-weight:900;" onclick="window.open('https://paypal.me/frsaamya/2.99')">PACK 10k ü™ô</div>
    </div>

<script>
    // Config & Init (Identique √† avant)
    const firebaseConfig = { apiKey: "AIzaSyDoNMSFtT2i8Eqt_G3UwR92AxbtHhumDF0", authDomain: "cyberdash-2baf5.firebaseapp.com", databaseURL: "https://cyberdash-2baf5-default-rtdb.europe-west1.firebasedatabase.app", projectId: "cyberdash-2baf5", storageBucket: "cyberdash-2baf5.firebasestorage.app", messagingSenderId: "360233647601", appId: "1:360233647601:web:60aa25f439019ed7511850" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const cvs = document.getElementById("cvs"); const ctx = cvs.getContext("2d"); cvs.width = 600; cvs.height = 1000;

    let user="", ip="", coins=0, record=0, reached=1, ballX=300, ballY=750, ballVX=0, state="LOGIN", score=0, keys={}, trailPoints=[], obs=[], pieces=[];
    let ballColor="#fff", currentTrail="none", owned=["#fff", "none"];

    function switchTab(tabId, el) {
        document.querySelectorAll('#left-col, #right-col, #game-col').forEach(c => c.classList.remove('active-tab'));
        document.getElementById(tabId).classList.add('active-tab');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function sync() { db.ref('users/'+ip).update({coins, record, reached, owned, ballColor, currentTrail, user}); }

    function init() {
        user = document.getElementById('nick').value.toUpperCase() || "PLAYER";
        document.getElementById('screen-login').classList.remove('active-screen');
        document.getElementById('screen-hub').classList.add('active-screen');
        fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{
            ip = d.ip.replace(/\./g, '_');
            db.ref('users/'+ip).on('value', s=>{
                const v = s.val()||{}; coins=v.coins||0; record=v.record||0; reached=v.reached||1; 
                owned=v.owned||["#fff", "none"]; ballColor=v.ballColor||"#fff"; currentTrail=v.currentTrail||"none";
                document.getElementById('user-coins').innerText = `${coins} ü™ô`;
                document.getElementById('hub-stats').innerText = `BEST: ${record} | NIV: ${reached}`;
                renderShop(); renderLvls();
            });
        });
        db.ref('users').orderByChild('record').limitToLast(10).on('value', s=>{
            let h=""; s.forEach(x=>{ let p=x.val(); h+=`<div class="item-card"><span>${p.user||'PILOT'}</span><b>${p.record||0}</b></div>`; });
            document.getElementById('leaderboard').innerHTML=h;
        });
    }

    // BOUTIQUE DATA
    const shopItems = [
        {id:"#fff", n:"WHITE", p:0, t:"skin"}, {id:"#00f2ff", n:"CYAN", p:200, t:"skin"}, {id:"BURGER", n:"BURGER üçî", p:1000, t:"skin"},
        {id:"SUN", n:"SOLEIL ‚òÄÔ∏è", p:1200, t:"skin"}, {id:"none", n:"SANS TRAINEE", p:0, t:"trail"}, {id:"rainbow", n:"RAINBOW üåà", p:1000, t:"trail"}
    ];

    function renderShop() {
        let h = ""; shopItems.forEach(item => {
            const isO = owned.includes(item.id); const isEq = (item.t === "skin") ? ballColor === item.id : currentTrail === item.id;
            h += `<div class="item-card"><div><b>${item.n}</b><br><small>${isO?'POSS√âD√â':item.p+' ü™ô'}</small></div>
            <button class="buy-btn ${isEq?'equipped':''}" onclick="buy('${item.id}',${item.p},'${item.t}')">${isO?(isEq?'√âQUIP√â':'CHOISIR'):'ACHETER'}</button></div>`;
        });
        document.getElementById('shop').innerHTML = h;
    }

    function buy(id, p, type) { if(owned.includes(id)){ if(type==="skin") ballColor=id; else currentTrail=id; } else if(coins>=p){ coins-=p; owned.push(id); if(type==="skin") ballColor=id; else currentTrail=id; } sync(); renderShop(); }
    function renderLvls() { let h=""; for(let i=1; i<=9; i++) h+=`<div class="btn-ui" style="opacity:${i<=reached?1:0.2}; padding:10px; margin:0;" onclick="if(${i<=reached})start(${i})">${i}</div>`; document.getElementById('lvls').innerHTML=h; }
    function start(l) { currentLvl=l; state="PLAY"; score=0; obs=[]; pieces=[]; ballX=300; ballVX=0; document.getElementById('screen-hub').classList.remove('active-screen'); }

    // CONTROLES MOBILES
    const setupBtn = (id, key) => {
        const btn = document.getElementById(id);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key]=true; });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key]=false; });
    };
    setupBtn('btn-L', 'L'); setupBtn('btn-R', 'R');
    window.onkeydown=e=>{ if(e.key.includes("Left"))keys["L"]=true; if(e.key.includes("Right"))keys["R"]=true; };
    window.onkeyup=e=>{ if(e.key.includes("Left"))keys["L"]=false; if(e.key.includes("Right"))keys["R"]=false; };

    function loop() {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,600,1000);
        if(state === "PLAY") {
            if(keys["L"]) ballVX -= 1.5; else if(keys["R"]) ballVX += 1.5;
            ballVX *= 0.85; ballX += ballVX; ballX = Math.max(30, Math.min(570, ballX));

            const speed = 5 + (currentLvl === 'INF' ? 3 : currentLvl*0.4);
            const gap = 180 - (currentLvl === 'INF' ? 30 : currentLvl*5);

            if(Math.random()<0.04 && (obs.length===0 || obs[obs.length-1].y > 350)) {
                let c = Math.random()*(600-gap-100)+(gap/2+50);
                obs.push({g:c, y:-50, p:false});
            }

            obs.forEach(o => {
                o.y += speed; ctx.fillStyle = "#00f2ff";
                ctx.fillRect(0, o.y, o.g-gap/2, 30); ctx.fillRect(o.g+gap/2, o.y, 600, 30);
                if(o.y>ballY-20 && o.y<ballY+20 && (ballX<o.g-gap/2+15 || ballX>o.g+gap/2-15)) { state="HUB"; document.getElementById('screen-hub').classList.add('active-screen'); sync(); }
                if(o.y > ballY && !o.p) { o.p=true; score++; }
            });

            ctx.fillStyle = ballColor.startsWith("#") ? ballColor : "#fff";
            ctx.beginPath(); ctx.arc(ballX, ballY, 20, 0, Math.PI*2); ctx.fill();
            if(!ballColor.startsWith("#")) { ctx.font="30px Arial"; ctx.fillText(ballColor==="BURGER"?"üçî":"‚òÄÔ∏è", ballX-15, ballY+10); }

            ctx.fillStyle="#fff"; ctx.font="80px Orbitron"; ctx.textAlign="center"; ctx.fillText(score, 300, 150);
        }
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
